<!DOCTYPE html>
<html>

<head>
    <title>Tasks</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

    <!-- Grid.js for table functionality -->
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>

    <!-- Custom stylesheet (optional) -->
    <link href="style.css" rel="stylesheet" />

</head>

<body style="display: flex">
    <!-- Sidebar iframe -->
    <iframe src="sidebar.html" style="border: none; width: 220px; height: 100vh" scrolling="no"
        title="Sidebar"></iframe>

    <!-- Main content container -->
    <div class="main-content" style="width: -webkit-fill-available; margin-left: 0px !important">

        <!-- Top-right user icon and home button -->
        <div style="margin-bottom: 20px; display: flex; justify-content: flex-end; align-items: center;">
            <a href="register.html" title="Register">
                <i class="fa-regular fa-circle-user fa-2x" style="margin-right: 15px; color: #276749"></i>
            </a>
            <a href="login.html" title="Login">
                <i class="fa-solid fa-house fa-2x" style="color: #276749"></i>
            </a>
        </div>

        <hr style="margin: 20px 0; border-color: #ccc" />

        <!-- Search by ID and Add + Reset buttons -->
        <div class="row" style="margin-bottom: 25px; align-items: center;">
            <div class="col-4 d-flex">
                <input type="number" id="searchByIdInput" class="form-control me-2" placeholder="Search by Task ID"
                    min="1" />
                <button id="searchByIdBtn" class="btn btn-outline-primary">Search</button>
            </div>
            <div class="col-2">
                <button id="resetGridBtn" class="btn btn-outline-secondary">Reset</button>
            </div>
            <div class="col-6 text-end">
                <button id="openAddModal" class="btn btn-primary" style="background-color: #2f855a">Add</button>
            </div>
        </div>

        <!-- Grid.js Table Container -->
        <div class="row">
            <div class="col-12">
                <div id="gridjs-wrapper"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Modal for Add/Edit -->
    <div class="modal fade" id="addPersonModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addDepModalLabel">Add Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTaskForm">
                        <div class="mb-3">
                            <label for="taskName" class="form-label">Task Name</label>
                            <input type="text" class="form-control" id="taskName" required />
                        </div>
                        <div class="mb-3">
                            <label for="departmentId" class="form-label">Department ID</label>
                            <input type="number" class="form-control" id="departmentId" required />
                        </div>
                        <div class="mb-3">
                            <label for="creationDate" class="form-label">Creation Date</label>
                            <input type="date" class="form-control" id="creationDate" required />
                        </div>
                        <div class="mb-3">
                            <label for="closureDate" class="form-label">Closure Date</label>
                            <input type="date" class="form-control" id="closureDate" required />
                        </div>
                        <div class="mb-3">
                            <label for="statusId" class="form-label">Status ID</label>
                            <input type="number" class="form-control" id="statusId" required />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="addTaskForm" class="btn btn-primary" id="submitAdd">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // Data for the table
        let gridData = [];
        const container = document.getElementById("gridjs-wrapper");
        let grid; // Grid instance

        // Render Grid.js table
        function renderGrid() {
            if (grid) grid.destroy();

            grid = new gridjs.Grid({
                columns: [
                    "ID",
                    "Name",
                    "Department ID",
                    "Creation Date",
                    "Closure Date",
                    "Status ID",
                    {
                        name: "Actions",
                        formatter: (_, row) => gridjs.html(`
      <div class="d-flex gap-2">
        <button class='btn btn-sm btn-success edit-btn' data-id='${row.cells[0].data}'>Edit</button>
        <button class='btn btn-sm btn-danger delete-btn' data-id='${row.cells[0].data}'>Delete</button>
      </div>
    `)
                    }
                ],

                data: gridData,
                pagination: { enabled: true, limit: 5 },
                sort: true,
                search: false
            });

            grid.render(container);

            // Attach table event listeners (delegated)
            setTimeout(() => {
                const table = container.querySelector("table");
                if (!table) return;
                table.removeEventListener("click", tableClickHandler);
                table.addEventListener("click", tableClickHandler);
            }, 0);
        }

        // Handle Edit/Delete button clicks
        function tableClickHandler(e) {
            const editBtn = e.target.closest(".edit-btn");
            const deleteBtn = e.target.closest(".delete-btn");

            // Edit logic
            if (editBtn) {
                const id = parseInt(editBtn.dataset.id);
                const row = gridData.find(r => r[0] === id);
                if (!row) return;

                document.getElementById("departmentName").value = row[1];
                document.getElementById("submitAdd").textContent = "Update";
                document.getElementById("submitAdd").setAttribute("data-edit-id", id);
                addPersonModal.show();
                return;
            }

            // Delete logic
            if (deleteBtn) {
                const id = parseInt(deleteBtn.dataset.id);
                if (confirm("Are you sure you want to delete this record?")) {
                    // Call backend to delete
                    $.ajax({
                        url: `https://localhost:44360/api/Task/Delete/${id}`,
                        method: 'DELETE',
                        success: function () {
                            fetchDepartments();
                        },
                        error: function () {
                            alert('Failed to delete employee.');
                        }
                    });
                }
            }
        }

        // Bootstrap Modal instance
        const addPersonModal = new bootstrap.Modal(document.getElementById("addPersonModal"));

        // Open modal to add a person
        document.getElementById("openAddModal").addEventListener("click", () => {
            document.getElementById("addTaskForm").reset();
            document.getElementById("submitAdd").textContent = "Add";
            document.getElementById("submitAdd").removeAttribute("data-edit-id");
            addPersonModal.show();
        });

        // Handle form submission
        document.getElementById("submitAdd").addEventListener("click", function () {
            const id = this.getAttribute("data-edit-id");
            const task = {
                name: document.getElementById("taskName").value,
                departmentId: parseInt(document.getElementById("departmentId").value),
                creationDate: document.getElementById("creationDate").value,
                closureDate: document.getElementById("closureDate").value,
                statusId: parseInt(document.getElementById("statusId").value)
            };

            if (!task.name || !task.creationDate || !task.closureDate || isNaN(task.statusId)) {
                alert("All fields are required.");
                return;
            }

            if (id) {
                // UPDATE
                task.id = parseInt(id);

                $.ajax({
                    url: "https://localhost:44360/api/Task/Update",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(task),
                    success: function () {
                        fetchTasks();
                        addPersonModal.hide();
                    },
                    error: function () {
                        alert("Failed to update task.");
                    }
                });
            } else {
                // ADD
                $.ajax({
                    url: "https://localhost:44360/api/Task/Add",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(task),
                    success: function () {
                        fetchTasks();
                        addPersonModal.hide();
                    },
                    error: function () {
                        alert("Failed to add task.");
                    }
                });
            }

            this.removeAttribute("data-edit-id");
        });

        //fetchDepartments();
    </script>

    <!-- MainContent collapse script -->
    <script>
        window.addEventListener("message", (event) => {
            const mainContent = document.querySelector(".main-content");
            const sidebarIframe = document.querySelector("iframe")

            if (event.data.sidebarCollapsed !== undefined) {
                if (event.data.sidebarCollapsed) {
                    mainContent.classList.add("collapsed");
                    sidebarIframe.style.width = "70px";
                } else {
                    mainContent.classList.remove("collapsed")
                    sidebarIframe.style.width = "220px";
                }
            }
        });
    </script>

    <script>
        function fetchTasks() {
            $.ajax({
                url: 'https://localhost:44360/api/Task/GetPaged',
                method: 'GET',
                success: function (data) {
                    gridData = data.items.map(task => [
                        task.id,
                        task.name
                    ]);
                    renderGrid();
                },
                error: function (xhr) {
                    console.error(xhr.responseText);
                    alert('Failed to fetch task data.');
                }
            });
        }
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetchDepartments(); // Load employee data when the page is fully loaded
        });
    </script>

    <script>
        document.getElementById("searchByIdBtn").addEventListener("click", function () {
            const id = document.getElementById("searchByIdInput").value;
            if (!id) {
                alert("Please enter an ID.");
                return;
            }

            $.ajax({
                url: `https://localhost:44360/api/Task/GetSingle/${id}`,
                method: 'GET',
                success: function (data) {
                    if (!data) {
                        alert("No task found.");
                        return;
                    }
                    gridData = [[data.id, data.name]];
                    renderGrid();
                },
                error: function () {
                    alert("Failed to fetch task by ID.");
                }
            });
        });

        document.getElementById("resetGridBtn").addEventListener("click", function () {
            fetchTasks();
            document.getElementById("searchByIdInput").value = "";
        });
    </script>

</body>

</html>